// src/services/pentest.service.js

/**
 * Penetration Test Service
 * Handles all pentest-related operations
 */

import { apiService } from './api.service.js';
import { API_ROUTES } from '../config/api.config.js';

class PentestService {
  /**
   * Get all pentests
   * @param {Object} filters - Optional filters (status, client, etc.)
   * @returns {Promise<Array>} List of pentests
   */
  async getAllPentests(filters = {}) {
    try {
      const queryParams = new URLSearchParams(filters).toString();
      const endpoint = queryParams 
        ? `${API_ROUTES.PENTESTS.LIST}?${queryParams}`
        : API_ROUTES.PENTESTS.LIST;

      const response = await apiService.get(endpoint);
      return response.data || response;
    } catch (error) {
      console.error('Failed to fetch pentests:', error);
      throw error;
    }
  }

  /**
   * Get single pentest by ID
   * @param {string|number} id 
   * @returns {Promise<Object>} Pentest data
   */
  async getPentestById(id) {
    try {
      const response = await apiService.get(API_ROUTES.PENTESTS.GET(id));
      return response.data || response;
    } catch (error) {
      console.error(`Failed to fetch pentest ${id}:`, error);
      throw error;
    }
  }

  /**
   * Create new pentest
   * @param {Object} pentestData 
   * @returns {Promise<Object>} Created pentest
   */
  async createPentest(pentestData) {
    try {
      const response = await apiService.post(API_ROUTES.PENTESTS.CREATE, pentestData);
      return response.data || response;
    } catch (error) {
      console.error('Failed to create pentest:', error);
      throw error;
    }
  }

  /**
   * Update existing pentest
   * @param {string|number} id 
   * @param {Object} updates 
   * @returns {Promise<Object>} Updated pentest
   */
  async updatePentest(id, updates) {
    try {
      const response = await apiService.put(API_ROUTES.PENTESTS.UPDATE(id), updates);
      return response.data || response;
    } catch (error) {
      console.error(`Failed to update pentest ${id}:`, error);
      throw error;
    }
  }

  /**
   * Delete pentest
   * @param {string|number} id 
   * @returns {Promise<void>}
   */
  async deletePentest(id) {
    try {
      await apiService.delete(API_ROUTES.PENTESTS.DELETE(id));
    } catch (error) {
      console.error(`Failed to delete pentest ${id}:`, error);
      throw error;
    }
  }

  /**
   * Get findings for a pentest
   * @param {string|number} id 
   * @returns {Promise<Array>} List of findings
   */
  async getPentestFindings(id) {
    try {
      const response = await apiService.get(API_ROUTES.PENTESTS.FINDINGS(id));
      return response.data || response;
    } catch (error) {
      console.error(`Failed to fetch findings for pentest ${id}:`, error);
      throw error;
    }
  }

  /**
   * Get active pentests
   * @returns {Promise<Array>} Active pentests
   */
  async getActivePentests() {
    return this.getAllPentests({ status: 'in-progress' });
  }

  /**
   * Get completed pentests
   * @returns {Promise<Array>} Completed pentests
   */
  async getCompletedPentests() {
    return this.getAllPentests({ status: 'completed' });
  }

  /**
   * Update pentest progress
   * @param {string|number} id 
   * @param {number} progress - Progress percentage (0-100)
   * @returns {Promise<Object>} Updated pentest
   */
  async updateProgress(id, progress) {
    return this.updatePentest(id, { progress });
  }

  /**
   * Update pentest status
   * @param {string|number} id 
   * @param {string} status - New status
   * @returns {Promise<Object>} Updated pentest
   */
  async updateStatus(id, status) {
    return this.updatePentest(id, { status });
  }
}

// Export singleton instance
export const pentestService = new PentestService();
export default pentestService;