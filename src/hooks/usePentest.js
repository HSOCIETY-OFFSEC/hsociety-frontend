// src/hooks/usePentests.js

/**
 * Custom hook for pentest operations
 * Provides easy access to pentest data and operations
 */

import { useState, useEffect, useCallback } from 'react';
import { pentestService } from '../services/pentest.service';

export const usePentests = (filters = {}) => {
  const [pentests, setPentests] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  /**
   * Fetch all pentests
   */
  const fetchPentests = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const data = await pentestService.getAllPentests(filters);
      setPentests(data);
      return data;
    } catch (err) {
      const errorMessage = err.message || 'Failed to fetch pentests';
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  }, [filters]);

  /**
   * Create new pentest
   */
  const createPentest = useCallback(async (pentestData) => {
    try {
      setLoading(true);
      setError(null);

      const newPentest = await pentestService.createPentest(pentestData);
      setPentests(prev => [newPentest, ...prev]);
      return newPentest;
    } catch (err) {
      const errorMessage = err.message || 'Failed to create pentest';
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * Update existing pentest
   */
  const updatePentest = useCallback(async (id, updates) => {
    try {
      setLoading(true);
      setError(null);

      const updatedPentest = await pentestService.updatePentest(id, updates);
      setPentests(prev =>
        prev.map(p => (p.id === id ? updatedPentest : p))
      );
      return updatedPentest;
    } catch (err) {
      const errorMessage = err.message || 'Failed to update pentest';
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * Delete pentest
   */
  const deletePentest = useCallback(async (id) => {
    try {
      setLoading(true);
      setError(null);

      await pentestService.deletePentest(id);
      setPentests(prev => prev.filter(p => p.id !== id));
    } catch (err) {
      const errorMessage = err.message || 'Failed to delete pentest';
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * Update pentest progress
   */
  const updateProgress = useCallback(async (id, progress) => {
    try {
      const updatedPentest = await pentestService.updateProgress(id, progress);
      setPentests(prev =>
        prev.map(p => (p.id === id ? updatedPentest : p))
      );
      return updatedPentest;
    } catch (err) {
      const errorMessage = err.message || 'Failed to update progress';
      setError(errorMessage);
      throw err;
    }
  }, []);

  /**
   * Update pentest status
   */
  const updateStatus = useCallback(async (id, status) => {
    try {
      const updatedPentest = await pentestService.updateStatus(id, status);
      setPentests(prev =>
        prev.map(p => (p.id === id ? updatedPentest : p))
      );
      return updatedPentest;
    } catch (err) {
      const errorMessage = err.message || 'Failed to update status';
      setError(errorMessage);
      throw err;
    }
  }, []);

  /**
   * Get pentest by ID
   */
  const getPentestById = useCallback(async (id) => {
    try {
      setLoading(true);
      setError(null);

      const pentest = await pentestService.getPentestById(id);
      return pentest;
    } catch (err) {
      const errorMessage = err.message || 'Failed to fetch pentest';
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   * Refresh pentests data
   */
  const refresh = useCallback(() => {
    return fetchPentests();
  }, [fetchPentests]);

  /**
   * Clear error
   */
  const clearError = useCallback(() => {
    setError(null);
  }, []);

  // Auto-fetch on mount
  useEffect(() => {
    fetchPentests();
  }, [fetchPentests]);

  return {
    pentests,
    loading,
    error,
    fetchPentests,
    createPentest,
    updatePentest,
    deletePentest,
    updateProgress,
    updateStatus,
    getPentestById,
    refresh,
    clearError,
  };
};

export default usePentests;