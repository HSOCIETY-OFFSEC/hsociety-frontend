import React, { useState, useEffect } from 'react';
import { FiAlertTriangle, FiBookOpen, FiCheckCircle, FiClipboard, FiEdit3, FiRefreshCw } from 'react-icons/fi';
import { useAuth } from '../../core/auth/AuthContext';
import Navbar from '../../shared/components/layout/Navbar';
import Card from '../../shared/components/ui/Card';
import Button from '../../shared/components/ui/Button';
import useScrollReveal from '../../shared/hooks/useScrollReveal';
import Skeleton from '../../shared/components/ui/Skeleton';
import { validateForm } from '../../core/validation/input.validator';
import '../../styles/features/pentest.css';

/**
 * Pentest Component
 * Location: src/features/pentest/Pentest.jsx
 * 
 * Features:
 * - Request penetration testing services
 * - View active/past pentest engagements
 * - Track pentest status
 * - Download reports
 * 
 * TODO: Backend integration for pentest management
 */

const Pentest = () => {
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState('request'); // 'request' | 'active' | 'history'
  const [loading, setLoading] = useState(false);
  const [engagements, setEngagements] = useState([]);
  
  // Request form state
  const [formData, setFormData] = useState({
    targetType: 'web-application',
    targetUrl: '',
    targetDescription: '',
    scope: '',
    preferredDate: '',
    urgency: 'normal',
    additionalNotes: ''
  });
  const [formErrors, setFormErrors] = useState({});
  const [submitSuccess, setSubmitSuccess] = useState(false);

  useScrollReveal('.reveal-on-scroll', {}, [activeTab, loading, engagements.length]);

  useEffect(() => {
    if (activeTab !== 'request') {
      loadEngagements();
    }
  }, [activeTab]);

  const loadEngagements = async () => {
    setLoading(true);
    
    try {
      // TODO: Backend integration
      // const response = await pentestService.getEngagements();
      
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Mock data
      const mockEngagements = [
        {
          id: '1',
          type: 'Web Application',
          target: 'https://example.com',
          status: 'in-progress',
          startDate: Date.now() - (5 * 24 * 60 * 60 * 1000),
          estimatedCompletion: Date.now() + (10 * 24 * 60 * 60 * 1000),
          tester: 'Security Team A'
        },
        {
          id: '2',
          type: 'Network Infrastructure',
          target: '192.168.1.0/24',
          status: 'completed',
          startDate: Date.now() - (30 * 24 * 60 * 60 * 1000),
          completedDate: Date.now() - (15 * 24 * 60 * 60 * 1000),
          tester: 'Security Team B',
          reportAvailable: true
        },
        {
          id: '3',
          type: 'Mobile Application',
          target: 'Android App v2.1',
          status: 'scheduled',
          scheduledDate: Date.now() + (7 * 24 * 60 * 60 * 1000),
          tester: 'Security Team C'
        }
      ];
      
      setEngagements(mockEngagements);
    } catch (error) {
      console.error('Failed to load engagements:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
    
    // Clear error for this field
    if (formErrors[name]) {
      setFormErrors(prev => ({
        ...prev,
        [name]: ''
      }));
    }
  };

  const handleSubmitRequest = async (e) => {
    e.preventDefault();
    setFormErrors({});
    setSubmitSuccess(false);

    // Validate form
    const validationRules = {
      targetUrl: { required: true, type: 'url' },
      targetDescription: { required: true, minLength: 20 },
      scope: { required: true, minLength: 10 },
      preferredDate: { required: true }
    };

    const validation = validateForm(formData, validationRules);

    if (!validation.isValid) {
      setFormErrors(validation.errors);
      return;
    }

    setLoading(true);

    try {
      // TODO: Backend integration
      // await pentestService.requestPentest(validation.sanitizedData);

      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1500));

      console.log('Pentest request submitted:', validation.sanitizedData);

      setSubmitSuccess(true);
      
      // Reset form
      setFormData({
        targetType: 'web-application',
        targetUrl: '',
        targetDescription: '',
        scope: '',
        preferredDate: '',
        urgency: 'normal',
        additionalNotes: ''
      });

      // Switch to active tab after 2 seconds
      setTimeout(() => {
        setActiveTab('active');
      }, 2000);
    } catch (error) {
      setFormErrors({ submit: 'Failed to submit request. Please try again.' });
      console.error('Pentest request failed:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'scheduled': return '#3b82f6';
      case 'in-progress': return '#f59e0b';
      case 'completed': return '#10b981';
      case 'cancelled': return '#ef4444';
      default: return '#6b7280';
    }
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'scheduled': return 'Scheduled';
      case 'in-progress': return 'In Progress';
      case 'completed': return 'Completed';
      case 'cancelled': return 'Cancelled';
      default: return 'Unknown';
    }
  };

  const formatDate = (timestamp) => {
    return new Date(timestamp).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };

  const renderRequestForm = () => (
    <Card padding="large" shadow="medium">
      <h2 className="section-title">Request Penetration Test</h2>
      <p className="section-subtitle">
        Submit a request for our security team to conduct a comprehensive penetration test
      </p>

      {submitSuccess && (
        <div className="success-message">
          <span className="success-icon">
            <FiCheckCircle size={18} />
          </span>
          <div>
            <strong>Request submitted successfully!</strong>
            <p>Our team will review your request and contact you within 24-48 hours.</p>
          </div>
        </div>
      )}

      {formErrors.submit && (
        <div className="error-message">
          <span className="error-icon">
            <FiAlertTriangle size={18} />
          </span>
          {formErrors.submit}
        </div>
      )}

      <form onSubmit={handleSubmitRequest} className="pentest-form">
        {/* Target Type */}
        <div className="form-group">
          <label htmlFor="targetType">Target Type *</label>
          <select
            id="targetType"
            name="targetType"
            value={formData.targetType}
            onChange={handleInputChange}
            className="form-input"
            required
          >
            <option value="web-application">Web Application</option>
            <option value="mobile-application">Mobile Application</option>
            <option value="api">API</option>
            <option value="network">Network Infrastructure</option>
            <option value="physical">Physical Security</option>
            <option value="social-engineering">Social Engineering</option>
          </select>
        </div>

        {/* Target URL/Identifier */}
        <div className="form-group">
          <label htmlFor="targetUrl">Target URL/Identifier *</label>
          <input
            type="text"
            id="targetUrl"
            name="targetUrl"
            value={formData.targetUrl}
            onChange={handleInputChange}
            placeholder="https://example.com or 192.168.1.0/24"
            className={`form-input ${formErrors.targetUrl ? 'error' : ''}`}
            required
          />
          {formErrors.targetUrl && (
            <span className="field-error">{formErrors.targetUrl}</span>
          )}
        </div>

        {/* Description */}
        <div className="form-group">
          <label htmlFor="targetDescription">Target Description *</label>
          <textarea
            id="targetDescription"
            name="targetDescription"
            value={formData.targetDescription}
            onChange={handleInputChange}
            placeholder="Describe the target system, its purpose, and key features..."
            rows={4}
            className={`form-input ${formErrors.targetDescription ? 'error' : ''}`}
            required
          />
          {formErrors.targetDescription && (
            <span className="field-error">{formErrors.targetDescription}</span>
          )}
          <span className="field-hint">Minimum 20 characters</span>
        </div>

        {/* Scope */}
        <div className="form-group">
          <label htmlFor="scope">Testing Scope *</label>
          <textarea
            id="scope"
            name="scope"
            value={formData.scope}
            onChange={handleInputChange}
            placeholder="Define what should and should not be tested. Include specific URLs, IP ranges, or features..."
            rows={4}
            className={`form-input ${formErrors.scope ? 'error' : ''}`}
            required
          />
          {formErrors.scope && (
            <span className="field-error">{formErrors.scope}</span>
          )}
          <span className="field-hint">Be specific about in-scope and out-of-scope items</span>
        </div>

        {/* Preferred Date & Urgency */}
        <div className="form-row">
          <div className="form-group">
            <label htmlFor="preferredDate">Preferred Start Date *</label>
            <input
              type="date"
              id="preferredDate"
              name="preferredDate"
              value={formData.preferredDate}
              onChange={handleInputChange}
              min={new Date().toISOString().split('T')[0]}
              className={`form-input ${formErrors.preferredDate ? 'error' : ''}`}
              required
            />
            {formErrors.preferredDate && (
              <span className="field-error">{formErrors.preferredDate}</span>
            )}
          </div>

          <div className="form-group">
            <label htmlFor="urgency">Urgency Level</label>
            <select
              id="urgency"
              name="urgency"
              value={formData.urgency}
              onChange={handleInputChange}
              className="form-input"
            >
              <option value="low">Low - Routine Assessment</option>
              <option value="normal">Normal - Standard Timeline</option>
              <option value="high">High - Priority Engagement</option>
              <option value="critical">Critical - Urgent Security Concern</option>
            </select>
          </div>
        </div>

        {/* Additional Notes */}
        <div className="form-group">
          <label htmlFor="additionalNotes">Additional Notes (Optional)</label>
          <textarea
            id="additionalNotes"
            name="additionalNotes"
            value={formData.additionalNotes}
            onChange={handleInputChange}
            placeholder="Any additional information, special requirements, or constraints..."
            rows={3}
            className="form-input"
          />
        </div>

        {/* Submit Button */}
        <div className="form-actions">
          <Button
            type="submit"
            variant="primary"
            size="large"
            loading={loading}
            disabled={loading}
          >
            {loading ? 'Submitting...' : 'Submit Request'}
          </Button>
        </div>
      </form>
    </Card>
  );

  const renderEngagements = (filterStatus) => {
    const filtered = filterStatus === 'active'
      ? engagements.filter(e => ['scheduled', 'in-progress'].includes(e.status))
      : engagements.filter(e => ['completed', 'cancelled'].includes(e.status));

    if (loading) {
      return (
        <div className="engagements-grid">
          {[...Array(3)].map((_, index) => (
            <Card key={index} padding="large" shadow="medium">
              <div className="engagement-card">
                <div className="engagement-header">
                  <Skeleton className="skeleton-line" style={{ width: '180px' }} />
                  <Skeleton className="skeleton-line" style={{ width: '90px', height: '20px' }} />
                </div>
                <div className="engagement-details">
                  {[...Array(3)].map((__, idx) => (
                    <div key={idx} className="detail-item">
                      <Skeleton className="skeleton-line" style={{ width: '80px' }} />
                      <Skeleton className="skeleton-line" style={{ width: '140px' }} />
                    </div>
                  ))}
                </div>
                <div className="engagement-footer">
                  <Skeleton className="skeleton-line" style={{ width: '140px' }} />
                  <Skeleton className="skeleton-rect" style={{ width: '110px', height: '36px', borderRadius: '8px' }} />
                </div>
              </div>
            </Card>
          ))}
        </div>
      );
    }

    if (filtered.length === 0) {
      return (
        <Card padding="large">
          <div className="empty-state">
            <span style={{ fontSize: '3rem', display: 'inline-flex' }}>
              <FiClipboard size={40} />
            </span>
            <h3>No {filterStatus} engagements</h3>
            <p>
              {filterStatus === 'active'
                ? 'You have no active or scheduled penetration tests.'
                : 'You have no completed penetration tests.'}
            </p>
            {filterStatus === 'active' && (
              <Button
                variant="primary"
                onClick={() => setActiveTab('request')}
                style={{ marginTop: '1rem' }}
              >
                Request New Pentest
              </Button>
            )}
          </div>
        </Card>
      );
    }

    return (
      <div className="engagements-grid">
        {filtered.map(engagement => (
          <Card key={engagement.id} hover3d={true} padding="large" shadow="medium">
            <div className="engagement-card">
              <div className="engagement-header">
                <h3 className="engagement-title">{engagement.type}</h3>
                <span
                  className="status-badge"
                  style={{
                    background: `${getStatusColor(engagement.status)}20`,
                    color: getStatusColor(engagement.status),
                    border: `1px solid ${getStatusColor(engagement.status)}50`
                  }}
                >
                  {getStatusLabel(engagement.status)}
                </span>
              </div>

              <div className="engagement-details">
                <div className="detail-item">
                  <span className="detail-label">Target:</span>
                  <span className="detail-value">{engagement.target}</span>
                </div>

                <div className="detail-item">
                  <span className="detail-label">Tester:</span>
                  <span className="detail-value">{engagement.tester}</span>
                </div>

                {engagement.status === 'scheduled' && (
                  <div className="detail-item">
                    <span className="detail-label">Scheduled:</span>
                    <span className="detail-value">{formatDate(engagement.scheduledDate)}</span>
                  </div>
                )}

                {engagement.status === 'in-progress' && (
                  <>
                    <div className="detail-item">
                      <span className="detail-label">Started:</span>
                      <span className="detail-value">{formatDate(engagement.startDate)}</span>
                    </div>
                    <div className="detail-item">
                      <span className="detail-label">Est. Completion:</span>
                      <span className="detail-value">{formatDate(engagement.estimatedCompletion)}</span>
                    </div>
                  </>
                )}

                {engagement.status === 'completed' && (
                  <>
                    <div className="detail-item">
                      <span className="detail-label">Completed:</span>
                      <span className="detail-value">{formatDate(engagement.completedDate)}</span>
                    </div>
                    {engagement.reportAvailable && (
                      <div className="detail-item">
                        <span className="detail-label">Report:</span>
                        <span className="detail-value">
                          <Button variant="ghost" size="small">
                            Download Report â†’
                          </Button>
                        </span>
                      </div>
                    )}
                  </>
                )}
              </div>

              <div className="engagement-actions">
                <Button variant="secondary" size="small" fullWidth>
                  View Details
                </Button>
              </div>
            </div>
          </Card>
        ))}
      </div>
    );
  };

  return (
    <>
      <Navbar />
      <div className="pentest-container">
        <div className="pentest-wrapper">
          {/* Header */}
          <div className="page-header reveal-on-scroll">
            <div>
              <h1 className="page-title">Penetration Testing</h1>
              <p className="page-subtitle">
                Request and manage security penetration testing engagements
              </p>
            </div>
          </div>

          {/* Tabs */}
          <div className="tabs-container reveal-on-scroll">
            <button
              className={`tab ${activeTab === 'request' ? 'active' : ''}`}
              onClick={() => setActiveTab('request')}
            >
              <FiEdit3 size={16} />
              Request New Test
            </button>
            <button
              className={`tab ${activeTab === 'active' ? 'active' : ''}`}
              onClick={() => setActiveTab('active')}
            >
              <FiRefreshCw size={16} />
              Active Engagements
            </button>
            <button
              className={`tab ${activeTab === 'history' ? 'active' : ''}`}
              onClick={() => setActiveTab('history')}
            >
              <FiBookOpen size={16} />
              History
            </button>
          </div>

          {/* Content */}
          <div className="tab-content reveal-on-scroll">
            {activeTab === 'request' && renderRequestForm()}
            {activeTab === 'active' && renderEngagements('active')}
            {activeTab === 'history' && renderEngagements('history')}
          </div>
        </div>
      </div>
    </>
  );
};

export default Pentest;
