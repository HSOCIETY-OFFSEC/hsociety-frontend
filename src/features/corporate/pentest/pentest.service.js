/**
 * Pentest service
 * Location: src/features/pentest/pentest.service.js
 */

import { API_ENDPOINTS } from '../../../config/api.config';
import { apiClient } from '../../../shared/services/api.client';
import { buildPentestRequestDTO, normalizeEngagements } from './pentest.contract';

const mockEngagements = [
  {
    id: '1',
    type: 'Web Application',
    target: 'https://example.com',
    status: 'in-progress',
    startDate: Date.now() - (5 * 24 * 60 * 60 * 1000),
    estimatedCompletion: Date.now() + (10 * 24 * 60 * 60 * 1000),
    tester: 'Security Team A'
  },
  {
    id: '2',
    type: 'Network Infrastructure',
    target: '192.168.1.0/24',
    status: 'completed',
    startDate: Date.now() - (30 * 24 * 60 * 60 * 1000),
    completedDate: Date.now() - (15 * 24 * 60 * 60 * 1000),
    tester: 'Security Team B',
    reportAvailable: true
  },
  {
    id: '3',
    type: 'Mobile Application',
    target: 'Android App v2.1',
    status: 'scheduled',
    scheduledDate: Date.now() + (7 * 24 * 60 * 60 * 1000),
    tester: 'Security Team C'
  }
];

export const getEngagements = async () => {
  const response = await apiClient.get(API_ENDPOINTS.PENTEST.LIST);
  if (response.success) {
    return {
      success: true,
      data: normalizeEngagements(Array.isArray(response.data) ? response.data : response.data?.items || [])
    };
  }

  if (import.meta.env.DEV) {
    return { success: true, data: normalizeEngagements(mockEngagements), isMock: true };
  }

  return { success: false, error: response.error || 'Failed to load engagements' };
};

export const requestPentest = async (formData) => {
  const payload = buildPentestRequestDTO(formData);
  const response = await apiClient.post(API_ENDPOINTS.PENTEST.CREATE, payload);
  if (response.success) {
    return {
      success: true,
      data: response.data
    };
  }

  if (import.meta.env.DEV) {
    return {
      success: true,
      data: {
        id: `pentest-${Date.now()}`,
        status: 'scheduled'
      },
      isMock: true
    };
  }

  return {
    success: false,
    error: response.error || 'Failed to submit pentest request'
  };
};

export default {
  getEngagements,
  requestPentest
};
