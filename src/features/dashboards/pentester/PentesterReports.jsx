import React, { useEffect, useState } from 'react';
import { FiClipboard, FiShield } from 'react-icons/fi';
import { useNavigate } from 'react-router-dom';
import Card from '../../../shared/components/ui/Card';
import Button from '../../../shared/components/ui/Button';
import PageLoader from '../../../shared/components/ui/PageLoader';
import {
  createPentestReport,
  getAssignedPentests,
  listPentesterReports,
} from './pentester.service';
import '../../../styles/dashboards/pentester/index.css';

const PentesterReports = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [reports, setReports] = useState([]);
  const [pentests, setPentests] = useState([]);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [draft, setDraft] = useState({
    pentestId: '',
    title: '',
    summary: '',
    fileName: '',
    fileUrl: '',
  });

  const load = async () => {
    setLoading(true);
    setError('');
    const [reportRes, pentestRes] = await Promise.all([
      listPentesterReports(),
      getAssignedPentests(),
    ]);

    if (reportRes.success) {
      setReports(reportRes.data || []);
    } else {
      setError(reportRes.error || 'Failed to load reports');
    }

    if (pentestRes.success) {
      setPentests(pentestRes.data || []);
      if (!draft.pentestId && pentestRes.data?.[0]?.id) {
        setDraft((prev) => ({ ...prev, pentestId: pentestRes.data[0].id }));
      }
    }

    setLoading(false);
  };

  useEffect(() => {
    load();
  }, []);

  const submit = async (status) => {
    setError('');
    setSuccess('');
    if (!draft.pentestId) {
      setError('Select an engagement before uploading a report.');
      return;
    }

    const payload = {
      title: draft.title,
      summary: draft.summary,
      status,
      attachments: draft.fileName && draft.fileUrl
        ? [{ name: draft.fileName, url: draft.fileUrl }]
        : [],
    };

    const response = await createPentestReport(draft.pentestId, payload);
    if (response.success) {
      setSuccess(status === 'draft' ? 'Report draft uploaded.' : 'Report submitted.');
      setDraft({
        pentestId: draft.pentestId,
        title: '',
        summary: '',
        fileName: '',
        fileUrl: '',
      });
      await load();
    } else {
      setError(response.error || 'Failed to upload report');
    }
  };

  if (loading) {
    return <PageLoader message="Loading reports..." durationMs={0} />;
  }

  return (
    <div className="pentester-dashboard">
      <div className="dashboard-shell">
        {(error || success) && (
          <div className={`pentester-alert ${success ? 'success' : ''}`}>
            {success || error}
          </div>
        )}

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Upload report</h2>
              <p className="pentester-section-subtitle">
                Add a report draft or submit a final report for an engagement.
              </p>
            </div>
          </div>

          <Card className="pentester-report-form" padding="large">
            <div className="pentester-form-grid">
              <div>
                <span className="pentester-label">Engagement</span>
                <select
                  className="pentester-select"
                  value={draft.pentestId}
                  onChange={(e) => setDraft((prev) => ({ ...prev, pentestId: e.target.value }))}
                >
                  <option value="">Select engagement</option>
                  {pentests.map((pentest) => (
                    <option key={pentest.id} value={pentest.id}>
                      {pentest.target || pentest.title || 'Untitled'}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <span className="pentester-label">Report title</span>
                <input
                  className="pentester-input"
                  value={draft.title}
                  onChange={(e) => setDraft((prev) => ({ ...prev, title: e.target.value }))}
                  placeholder="Engagement report"
                />
              </div>
            </div>
            <div className="pentester-form-grid">
              <div>
                <span className="pentester-label">Summary</span>
                <textarea
                  className="pentester-textarea"
                  value={draft.summary}
                  onChange={(e) => setDraft((prev) => ({ ...prev, summary: e.target.value }))}
                  placeholder="Key findings, overall risk posture, and next steps."
                />
              </div>
            </div>
            <div className="pentester-form-grid">
              <div>
                <span className="pentester-label">File name</span>
                <input
                  className="pentester-input"
                  value={draft.fileName}
                  onChange={(e) => setDraft((prev) => ({ ...prev, fileName: e.target.value }))}
                  placeholder="Report.pdf"
                />
              </div>
              <div>
                <span className="pentester-label">File URL</span>
                <input
                  className="pentester-input"
                  value={draft.fileUrl}
                  onChange={(e) => setDraft((prev) => ({ ...prev, fileUrl: e.target.value }))}
                  placeholder="https://storage.example.com/report.pdf"
                />
              </div>
            </div>
            <div className="pentester-form-actions">
              <Button size="small" variant="ghost" onClick={() => submit('draft')}>
                Save draft
              </Button>
              <Button size="small" variant="primary" onClick={() => submit('submitted')}>
                Submit report
              </Button>
            </div>
          </Card>
        </section>

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Your reports</h2>
              <p className="pentester-section-subtitle">Track the reports you have delivered.</p>
            </div>
          </div>

          <div className="pentester-report-grid">
            {reports.map((report) => (
              <Card key={report.id} className="pentester-report-card" padding="medium">
                <div className="pentester-report-header">
                  <FiClipboard size={18} />
                  <div>
                    <strong>{report.title}</strong>
                    <span>{report.status}</span>
                  </div>
                </div>
                <p>{report.summary || 'No summary provided.'}</p>
                <div className="pentester-report-meta">
                  <span>{report.findingsCount || 0} findings</span>
                  {report.date && (
                    <span>{new Date(report.date).toLocaleDateString()}</span>
                  )}
                </div>
                <div className="pentester-card-actions">
                  <Button
                    size="small"
                    variant="ghost"
                    onClick={() => navigate(`/pentester/engagements/${report.pentestId}`)}
                  >
                    View engagement
                  </Button>
                </div>
              </Card>
            ))}
            {reports.length === 0 && (
              <div className="pentester-empty">
                <FiShield size={24} />
                <p>No reports uploaded yet.</p>
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default PentesterReports;
