import React, { useEffect, useMemo, useState } from 'react';
import { FiArrowRight, FiShield, FiTarget, FiUser, FiUsers } from 'react-icons/fi';
import { useNavigate } from 'react-router-dom';
import Card from '../../../shared/components/ui/Card';
import Button from '../../../shared/components/ui/Button';
import PageLoader from '../../../shared/components/ui/PageLoader';
import { getGithubAvatarDataUri } from '../../../shared/utils/avatar';
import { getAssignedPentests, getPentesterProfiles } from './pentester.service';
import '../../../styles/dashboards/pentester/index.css';

const ACTIVE_STATUSES = new Set(['pending', 'in-progress', 'draft']);

const PentesterDashboard = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [pentests, setPentests] = useState([]);
  const [profiles, setProfiles] = useState([]);
  const [error, setError] = useState('');

  useEffect(() => {
    let mounted = true;

    const load = async () => {
      setLoading(true);
      setError('');
      const [pentestRes, profileRes] = await Promise.all([
        getAssignedPentests(),
        getPentesterProfiles(),
      ]);

      if (!mounted) return;

      if (pentestRes.success) {
        setPentests(pentestRes.data || []);
      } else {
        setError(pentestRes.error || 'Failed to load engagements');
      }

      if (profileRes.success) {
        setProfiles(profileRes.data || []);
      } else if (!pentestRes.success) {
        setError(profileRes.error || 'Failed to load pentester network');
      }

      setLoading(false);
    };

    load();

    return () => {
      mounted = false;
    };
  }, []);

  const activePentests = useMemo(
    () => pentests.filter((item) => ACTIVE_STATUSES.has(item.status)),
    [pentests]
  );

  const completedPentests = useMemo(
    () => pentests.filter((item) => item.status === 'completed'),
    [pentests]
  );

  const pendingReports = useMemo(
    () => activePentests.filter((item) => !item.reportAvailable).length,
    [activePentests]
  );

  if (loading) {
    return <PageLoader message="Loading pentester workspace..." durationMs={0} />;
  }

  return (
    <div className="pentester-dashboard">
      <div className="dashboard-shell">
        <div className="pentester-summary-grid">
          <Card className="pentester-summary-card" padding="medium">
            <div className="pentester-summary-icon">
              <FiShield size={18} />
            </div>
            <div>
              <span className="pentester-label">Active engagements</span>
              <strong>{activePentests.length}</strong>
            </div>
          </Card>
          <Card className="pentester-summary-card" padding="medium">
            <div className="pentester-summary-icon">
              <FiTarget size={18} />
            </div>
            <div>
              <span className="pentester-label">Completed</span>
              <strong>{completedPentests.length}</strong>
            </div>
          </Card>
          <Card className="pentester-summary-card" padding="medium">
            <div className="pentester-summary-icon">
              <FiUser size={18} />
            </div>
            <div>
              <span className="pentester-label">Pending reports</span>
              <strong>{pendingReports}</strong>
            </div>
          </Card>
        </div>

        {error && <div className="pentester-alert">{error}</div>}

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Active engagements</h2>
              <p className="pentester-section-subtitle">
                Review your assignments, update status, and submit reports.
              </p>
            </div>
            <Button
              size="small"
              variant="ghost"
              onClick={() => navigate('/pentester/engagements')}
            >
              Manage engagements
              <FiArrowRight size={14} />
            </Button>
          </div>

          <div className="pentester-grid">
            {activePentests.slice(0, 3).map((pentest) => {
              const pentestId = pentest.id || pentest._id;
              return (
                <Card key={pentestId} className="pentester-card" padding="medium">
                  <div className="pentester-card-header">
                    <div>
                      <span className="pentester-label">Target</span>
                      <h3>{pentest.target || pentest.title || 'Untitled'}</h3>
                    </div>
                    <span className={`pentester-status status-${pentest.status || 'pending'}`}>
                      {pentest.status || 'pending'}
                    </span>
                  </div>
                  <div className="pentester-card-body">
                    <p>
                      <FiTarget size={14} /> {pentest.type || 'Security Test'}
                    </p>
                    {pentest.startDate && (
                      <p>Started: {new Date(pentest.startDate).toLocaleDateString()}</p>
                    )}
                  </div>
                  <div className="pentester-card-actions">
                    <Button
                      size="small"
                      variant="ghost"
                      onClick={() => navigate(`/pentester/engagements/${pentestId}`)}
                    >
                      View engagement
                    </Button>
                  </div>
                </Card>
              );
            })}
            {activePentests.length === 0 && (
              <div className="pentester-empty">
                <FiShield size={24} />
                <p>No active engagements right now.</p>
              </div>
            )}
          </div>
        </section>

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Pentester network</h2>
              <p className="pentester-section-subtitle">
                Connect with other pentesters working inside HSOCIETY.
              </p>
            </div>
            <Button
              size="small"
              variant="ghost"
              onClick={() => navigate('/pentester/profiles')}
            >
              View all
              <FiArrowRight size={14} />
            </Button>
          </div>

          <div className="pentester-profiles-grid">
            {profiles.slice(0, 4).map((profile) => {
              const fallback = getGithubAvatarDataUri(profile.name || 'pentester');
              const handleText =
                profile.hackerHandle && profile.hackerHandle.trim()
                  ? `@${profile.hackerHandle.trim()}`
                  : `@${(profile.name || 'pentester').split(' ')[0].toLowerCase() || 'pentester'}`;
              return (
                <Card key={profile.id} className="pentester-profile-card" padding="medium">
                  <div className="pentester-profile-row">
                    <img
                      src={profile.avatarUrl || fallback}
                      alt={profile.name}
                      onError={(e) => {
                        if (e.currentTarget.src !== fallback) {
                          e.currentTarget.src = fallback;
                        }
                      }}
                    />
                    <div>
                      <strong>{profile.name}</strong>
                      <span>{profile.organization || 'Independent'}</span>
                    </div>
                  </div>
                  <span className="pentester-profile-handle">{handleText}</span>
                  <p className="pentester-profile-bio">
                    {profile.bio || 'Focus, specialties, and experience are still being added.'}
                  </p>
                  <div className="pentester-profile-metrics">
                    <div>
                      <span className="pentester-label">Active</span>
                      <strong>{profile.activeEngagements || 0}</strong>
                    </div>
                    <div>
                      <span className="pentester-label">Completed</span>
                      <strong>{profile.completedEngagements || 0}</strong>
                    </div>
                  </div>
                </Card>
              );
            })}
            {profiles.length === 0 && (
              <div className="pentester-empty">
                <FiUsers size={24} />
                <p>No pentester profiles available yet.</p>
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default PentesterDashboard;
