import React, { useEffect, useMemo, useState } from 'react';
import { FiCheckCircle, FiClipboard, FiPlus, FiSave, FiShield } from 'react-icons/fi';
import { useNavigate, useParams } from 'react-router-dom';
import Card from '../../../shared/components/ui/Card';
import Button from '../../../shared/components/ui/Button';
import PageLoader from '../../../shared/components/ui/PageLoader';
import {
  createPentestReport,
  getPentestDetails,
  getPentestReports,
  updatePentest,
} from './pentester.service';
import '../../../styles/dashboards/pentester/index.css';

const STATUS_OPTIONS = ['pending', 'in-progress', 'completed', 'cancelled'];

const emptyFinding = () => ({
  title: '',
  severity: 'medium',
  description: '',
  remediation: '',
});

const PentesterEngagementDetails = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [details, setDetails] = useState(null);
  const [reports, setReports] = useState([]);
  const [statusDraft, setStatusDraft] = useState('');
  const [reportDraft, setReportDraft] = useState({
    title: '',
    summary: '',
    findings: [emptyFinding()],
    attachments: [],
  });
  const [attachmentDraft, setAttachmentDraft] = useState({ name: '', url: '' });
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  const loadData = async () => {
    setLoading(true);
    setError('');
    setSuccess('');

    const [detailsRes, reportsRes] = await Promise.all([
      getPentestDetails(id),
      getPentestReports(id),
    ]);

    if (detailsRes.success) {
      setDetails(detailsRes.data);
      setStatusDraft(detailsRes.data.status || 'pending');
      setReportDraft((prev) => ({
        ...prev,
        title: detailsRes.data.title ? `${detailsRes.data.title} Report` : prev.title,
      }));
    } else {
      setError(detailsRes.error || 'Failed to load engagement');
    }

    if (reportsRes.success) {
      setReports(reportsRes.data?.reports || []);
    } else if (!detailsRes.success) {
      setError(reportsRes.error || 'Failed to load reports');
    }

    setLoading(false);
  };

  useEffect(() => {
    loadData();
  }, [id]);

  const handleStatusSave = async () => {
    setSaving(true);
    setError('');
    const response = await updatePentest(id, { status: statusDraft });
    if (response.success) {
      setDetails((prev) => ({ ...prev, status: statusDraft }));
      setSuccess('Status updated.');
    } else {
      setError(response.error || 'Failed to update status');
    }
    setSaving(false);
  };

  const updateFinding = (index, field, value) => {
    setReportDraft((prev) => {
      const next = [...prev.findings];
      next[index] = { ...next[index], [field]: value };
      return { ...prev, findings: next };
    });
  };

  const addFinding = () => {
    setReportDraft((prev) => ({ ...prev, findings: [...prev.findings, emptyFinding()] }));
  };

  const removeFinding = (index) => {
    setReportDraft((prev) => {
      const next = prev.findings.filter((_, idx) => idx !== index);
      return { ...prev, findings: next.length ? next : [emptyFinding()] };
    });
  };

  const addAttachment = () => {
    if (!attachmentDraft.name || !attachmentDraft.url) return;
    setReportDraft((prev) => ({
      ...prev,
      attachments: [...prev.attachments, { ...attachmentDraft }],
    }));
    setAttachmentDraft({ name: '', url: '' });
  };

  const submitReport = async (status) => {
    setSaving(true);
    setError('');
    setSuccess('');

    const payload = {
      ...reportDraft,
      status,
    };
    const response = await createPentestReport(id, payload);
    if (response.success) {
      setSuccess(status === 'draft' ? 'Draft saved.' : 'Report submitted.');
      setReportDraft({ title: reportDraft.title, summary: '', findings: [emptyFinding()], attachments: [] });
      await loadData();
    } else {
      setError(response.error || 'Failed to submit report');
    }

    setSaving(false);
  };

  const scopeList = useMemo(() => {
    if (!details?.scope) return [];
    if (Array.isArray(details.scope)) return details.scope;
    return String(details.scope || '').split(/[,\n]/).map((item) => item.trim()).filter(Boolean);
  }, [details]);

  if (loading) {
    return <PageLoader message="Loading engagement..." durationMs={0} />;
  }

  if (!details) {
    return (
      <div className="pentester-dashboard">
        <div className="dashboard-shell">
          <div className="pentester-alert">Engagement not found.</div>
          <Button variant="ghost" size="small" onClick={() => navigate('/pentester/engagements')}>
            Back to engagements
          </Button>
        </div>
      </div>
    );
  }

  const target = details.metadata?.target || {};

  return (
    <div className="pentester-dashboard">
      <div className="dashboard-shell">
        <div className="pentester-detail-header">
          <div>
            <span className="pentester-label">Engagement</span>
            <h2>{details.title || target.identifier || 'Pentest engagement'}</h2>
            <p>{details.description || target.description || 'No description provided.'}</p>
          </div>
          <div className="pentester-detail-status">
            <span className={`pentester-status status-${details.status || 'pending'}`}>
              {details.status || 'pending'}
            </span>
          </div>
        </div>

        {(error || success) && (
          <div className={`pentester-alert ${success ? 'success' : ''}`}>
            {success || error}
          </div>
        )}

        <div className="pentester-detail-grid">
          <Card padding="medium" className="pentester-detail-card">
            <h3>Engagement details</h3>
            <div className="pentester-detail-list">
              <div>
                <span className="pentester-label">Target</span>
                <strong>{target.identifier || details.title || '—'}</strong>
              </div>
              <div>
                <span className="pentester-label">Domain</span>
                <strong>{target.domain || details.domain || '—'}</strong>
              </div>
              <div>
                <span className="pentester-label">URL</span>
                <strong>{target.url || details.url || '—'}</strong>
              </div>
              <div>
                <span className="pentester-label">Type</span>
                <strong>{target.type || details.type || 'Security Test'}</strong>
              </div>
            </div>
            {scopeList.length > 0 && (
              <div className="pentester-detail-scope">
                <span className="pentester-label">Scope</span>
                <div className="pentester-chip-row">
                  {scopeList.map((item) => (
                    <span key={item} className="pentester-chip">
                      {item}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </Card>
          <Card padding="medium" className="pentester-detail-card">
            <h3>Engagement actions</h3>
            <div className="pentester-detail-actions">
              <div>
                <span className="pentester-label">Update status</span>
                <select
                  className="pentester-select"
                  value={statusDraft}
                  onChange={(e) => setStatusDraft(e.target.value)}
                >
                  {STATUS_OPTIONS.map((status) => (
                    <option key={status} value={status}>
                      {status}
                    </option>
                  ))}
                </select>
              </div>
              <Button size="small" variant="primary" onClick={handleStatusSave} disabled={saving}>
                <FiSave size={14} />
                {saving ? 'Saving...' : 'Save status'}
              </Button>
              <Button
                size="small"
                variant="ghost"
                onClick={() => navigate('/pentester/engagements')}
              >
                Back to engagements
              </Button>
            </div>
          </Card>
        </div>

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Reports</h2>
              <p className="pentester-section-subtitle">
                Review past submissions and deliver the final report.
              </p>
            </div>
          </div>
          <div className="pentester-report-grid">
            {reports.map((report) => (
              <Card key={report.id} className="pentester-report-card" padding="medium">
                <div className="pentester-report-header">
                  <FiClipboard size={18} />
                  <div>
                    <strong>{report.title}</strong>
                    <span>{report.status}</span>
                  </div>
                </div>
                <p>{report.summary || 'No summary provided.'}</p>
                <div className="pentester-report-meta">
                  <span>{report.findingsCount || 0} findings</span>
                  {report.submittedAt && (
                    <span>Submitted: {new Date(report.submittedAt).toLocaleDateString()}</span>
                  )}
                </div>
              </Card>
            ))}
            {reports.length === 0 && (
              <div className="pentester-empty">
                <FiClipboard size={24} />
                <p>No reports submitted yet.</p>
              </div>
            )}
          </div>
        </section>

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Submit a report</h2>
              <p className="pentester-section-subtitle">
                Add findings and remediation suggestions before submitting.
              </p>
            </div>
          </div>

          <Card className="pentester-report-form" padding="large">
            <div className="pentester-form-grid">
              <div>
                <span className="pentester-label">Report title</span>
                <input
                  className="pentester-input"
                  value={reportDraft.title}
                  onChange={(e) => setReportDraft((prev) => ({ ...prev, title: e.target.value }))}
                  placeholder="Engagement report"
                />
              </div>
              <div>
                <span className="pentester-label">Summary</span>
                <textarea
                  className="pentester-textarea"
                  value={reportDraft.summary}
                  onChange={(e) => setReportDraft((prev) => ({ ...prev, summary: e.target.value }))}
                  placeholder="Key findings, overall risk posture, and next steps."
                />
              </div>
            </div>

            <div className="pentester-form-section">
              <div className="pentester-form-section-header">
                <h3>Findings and remediations</h3>
                <Button size="small" variant="ghost" onClick={addFinding}>
                  <FiPlus size={14} />
                  Add finding
                </Button>
              </div>
              <div className="pentester-findings">
                {reportDraft.findings.map((finding, index) => (
                  <div key={`finding-${index}`} className="pentester-finding-card">
                    <div className="pentester-form-grid">
                      <div>
                        <span className="pentester-label">Title</span>
                        <input
                          className="pentester-input"
                          value={finding.title}
                          onChange={(e) => updateFinding(index, 'title', e.target.value)}
                          placeholder="SQL Injection in auth flow"
                        />
                      </div>
                      <div>
                        <span className="pentester-label">Severity</span>
                        <select
                          className="pentester-select"
                          value={finding.severity}
                          onChange={(e) => updateFinding(index, 'severity', e.target.value)}
                        >
                          {['critical', 'high', 'medium', 'low', 'info'].map((level) => (
                            <option key={level} value={level}>
                              {level}
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>
                    <div className="pentester-form-grid">
                      <div>
                        <span className="pentester-label">Description</span>
                        <textarea
                          className="pentester-textarea"
                          value={finding.description}
                          onChange={(e) => updateFinding(index, 'description', e.target.value)}
                          placeholder="Explain the vulnerability and reproduction steps."
                        />
                      </div>
                      <div>
                        <span className="pentester-label">Remediation</span>
                        <textarea
                          className="pentester-textarea"
                          value={finding.remediation}
                          onChange={(e) => updateFinding(index, 'remediation', e.target.value)}
                          placeholder="Suggested fix and mitigation steps."
                        />
                      </div>
                    </div>
                    <div className="pentester-finding-actions">
                      <Button size="small" variant="ghost" onClick={() => removeFinding(index)}>
                        Remove
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="pentester-form-section">
              <div className="pentester-form-section-header">
                <h3>Attachments</h3>
              </div>
              <div className="pentester-form-grid">
                <div>
                  <span className="pentester-label">File name</span>
                  <input
                    className="pentester-input"
                    value={attachmentDraft.name}
                    onChange={(e) => setAttachmentDraft((prev) => ({ ...prev, name: e.target.value }))}
                    placeholder="Report.pdf"
                  />
                </div>
                <div>
                  <span className="pentester-label">File URL</span>
                  <input
                    className="pentester-input"
                    value={attachmentDraft.url}
                    onChange={(e) => setAttachmentDraft((prev) => ({ ...prev, url: e.target.value }))}
                    placeholder="https://storage.example.com/report.pdf"
                  />
                </div>
              </div>
              <Button size="small" variant="ghost" onClick={addAttachment}>
                <FiPlus size={14} />
                Add attachment
              </Button>
              {reportDraft.attachments.length > 0 && (
                <div className="pentester-attachment-list">
                  {reportDraft.attachments.map((item, index) => (
                    <div key={`att-${index}`} className="pentester-attachment-item">
                      <FiShield size={14} />
                      <span>{item.name}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="pentester-form-actions">
              <Button size="small" variant="ghost" onClick={() => submitReport('draft')} disabled={saving}>
                <FiSave size={14} />
                Save draft
              </Button>
              <Button size="small" variant="primary" onClick={() => submitReport('submitted')} disabled={saving}>
                <FiCheckCircle size={14} />
                Submit report
              </Button>
            </div>
          </Card>
        </section>
      </div>
    </div>
  );
};

export default PentesterEngagementDetails;
