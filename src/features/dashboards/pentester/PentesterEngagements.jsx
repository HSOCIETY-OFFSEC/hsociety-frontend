import React, { useEffect, useMemo, useState } from 'react';
import { FiCheckCircle, FiClock, FiShield, FiTarget } from 'react-icons/fi';
import { useNavigate } from 'react-router-dom';
import Card from '../../../shared/components/ui/Card';
import Button from '../../../shared/components/ui/Button';
import PageLoader from '../../../shared/components/ui/PageLoader';
import { getAssignedPentests, updatePentest } from './pentester.service';
import '../../../styles/dashboards/pentester/index.css';

const STATUS_OPTIONS = ['pending', 'in-progress', 'completed', 'cancelled'];
const ACTIVE_STATUSES = new Set(['pending', 'in-progress', 'draft']);

const PentesterEngagements = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [pentests, setPentests] = useState([]);
  const [editingId, setEditingId] = useState(null);
  const [statusDraft, setStatusDraft] = useState('');
  const [error, setError] = useState('');

  const loadPentests = async () => {
    setLoading(true);
    setError('');
    const response = await getAssignedPentests();
    if (response.success) {
      setPentests(response.data || []);
    } else {
      setError(response.error || 'Failed to load engagements');
    }
    setLoading(false);
  };

  useEffect(() => {
    loadPentests();
  }, []);

  const startEdit = (pentest) => {
    setEditingId(pentest.id || pentest._id);
    setStatusDraft(pentest.status || 'pending');
  };

  const saveStatus = async (pentestId) => {
    const response = await updatePentest(pentestId, { status: statusDraft });
    if (response.success) {
      setPentests((prev) =>
        prev.map((item) =>
          (item.id || item._id) === pentestId ? { ...item, status: statusDraft } : item
        )
      );
      setEditingId(null);
    } else {
      setError(response.error || 'Failed to update status');
    }
  };

  const activePentests = useMemo(
    () => pentests.filter((item) => ACTIVE_STATUSES.has(item.status)),
    [pentests]
  );
  const completedPentests = useMemo(
    () => pentests.filter((item) => !ACTIVE_STATUSES.has(item.status)),
    [pentests]
  );

  if (loading) {
    return <PageLoader message="Loading engagements..." durationMs={0} />;
  }

  const renderCard = (pentest) => {
    const pentestId = pentest.id || pentest._id;
    const isEditing = editingId === pentestId;

    return (
      <Card key={pentestId} className="pentester-card" padding="medium">
        <div className="pentester-card-header">
          <div>
            <span className="pentester-label">Target</span>
            <h3>{pentest.target || pentest.title || 'Untitled'}</h3>
          </div>
          <span className={`pentester-status status-${pentest.status || 'pending'}`}>
            {pentest.status || 'pending'}
          </span>
        </div>
        <div className="pentester-card-body">
          <p>
            <FiTarget size={14} /> {pentest.type || 'Security Test'}
          </p>
          {pentest.startDate && <p>Started: {new Date(pentest.startDate).toLocaleDateString()}</p>}
          {pentest.completedDate && (
            <p>Completed: {new Date(pentest.completedDate).toLocaleDateString()}</p>
          )}
        </div>
        <div className="pentester-card-actions">
          <Button
            size="small"
            variant="ghost"
            onClick={() => navigate(`/pentester/engagements/${pentestId}`)}
          >
            View details
          </Button>
          {!isEditing && (
            <Button size="small" variant="ghost" onClick={() => startEdit(pentest)}>
              Update status
            </Button>
          )}
          {isEditing && (
            <>
              <select
                className="pentester-select"
                value={statusDraft}
                onChange={(e) => setStatusDraft(e.target.value)}
              >
                {STATUS_OPTIONS.map((status) => (
                  <option key={status} value={status}>
                    {status}
                  </option>
                ))}
              </select>
              <Button size="small" variant="primary" onClick={() => saveStatus(pentestId)}>
                <FiCheckCircle size={14} />
                Save
              </Button>
            </>
          )}
        </div>
      </Card>
    );
  };

  return (
    <div className="pentester-dashboard">
      <div className="dashboard-shell">
        {error && <div className="pentester-alert">{error}</div>}

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Active engagements</h2>
              <p className="pentester-section-subtitle">Assignments currently in motion.</p>
            </div>
            <div className="pentester-section-meta">
              <FiShield size={16} /> {activePentests.length} active
            </div>
          </div>
          <div className="pentester-grid">
            {activePentests.map(renderCard)}
            {activePentests.length === 0 && (
              <div className="pentester-empty">
                <FiClock size={24} />
                <p>No active engagements right now.</p>
              </div>
            )}
          </div>
        </section>

        <section className="pentester-section">
          <div className="pentester-section-header">
            <div>
              <h2 className="pentester-section-title">Completed engagements</h2>
              <p className="pentester-section-subtitle">Review submitted work and reports.</p>
            </div>
          </div>
          <div className="pentester-grid">
            {completedPentests.map(renderCard)}
            {completedPentests.length === 0 && (
              <div className="pentester-empty">
                <FiShield size={24} />
                <p>No completed engagements yet.</p>
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default PentesterEngagements;
