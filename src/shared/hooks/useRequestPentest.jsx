import { useCallback, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { FiShield } from 'react-icons/fi';
import Card from '../../shared/components/ui/Card';
import Button from '../../shared/components/ui/Button';
import { useAuth } from '../../core/auth/AuthContext';
import '../../styles/shared/components/ui/requestPentest.css';

const redirectParams = new URLSearchParams({
  accountType: 'corporate',
  redirect: '/corporate/pentest'
}).toString();
const corporateRegisterPath = '/register/corporate';

export const useRequestPentest = () => {
  const navigate = useNavigate();
  const { isAuthenticated, user } = useAuth();
  const [isModalOpen, setModalOpen] = useState(false);

  const closeModal = () => {
    setModalOpen(false);
  };

  const navigateToRegister = useCallback(() => {
      navigate(`${corporateRegisterPath}?${redirectParams}`);
  }, [navigate]);

  const requestPentest = useCallback(() => {
    if (!isAuthenticated) {
      navigateToRegister();
      return;
    }

    const role = user?.role === 'client' ? 'corporate' : user?.role;

    if (role === 'corporate') {
      navigate('/corporate/pentest');
      return;
    }

    setModalOpen(true);
  }, [isAuthenticated, navigate, navigateToRegister, user]);

  const modal = isModalOpen && (
    <div
      className="request-pentest-modal-backdrop"
      onClick={closeModal}
      role="presentation"
    >
      <div
        className="request-pentest-modal"
        role="dialog"
        aria-modal="true"
        aria-label="Corporate account required"
        onClick={(event) => event.stopPropagation()}
      >
        <Card padding="large" className="request-pentest-modal-card">
          <div className="request-pentest-modal-icon">
            <FiShield size={28} />
          </div>
          <h3>Corporate access required</h3>
          <p>
            Penetration tests are reserved for corporate customers. Contact us to explore
            a partnership or register a corporate account when you are ready.
          </p>
          <div className="request-pentest-modal-actions">
            <Button
              variant="primary"
              size="medium"
              onClick={() => {
                closeModal();
                navigate('/contact');
              }}
            >
              Contact HSOCIETY
            </Button>
            <Button
              variant="ghost"
              size="medium"
              onClick={() => {
                closeModal();
                navigate(`${corporateRegisterPath}?${redirectParams}`);
              }}
            >
              Register corporate account
            </Button>
          </div>
        </Card>
      </div>
    </div>
  );

  return { requestPentest, requestPentestModal: modal };
};

export default useRequestPentest;
