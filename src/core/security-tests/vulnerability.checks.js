const toIssue = (id, severity, message, details = '') => ({
  id,
  severity,
  message,
  details,
});

export const runFrontendVulnerabilityChecks = () => {
  if (typeof window === 'undefined' || typeof document === 'undefined') {
    return [];
  }

  const issues = [];

  const isHttps = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
  if (!isHttps) {
    issues.push(
      toIssue('transport', 'high', 'Application is not running over HTTPS', window.location.href)
    );
  }

  const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
  if (!cspMeta) {
    issues.push(
      toIssue(
        'csp',
        'medium',
        'No CSP meta tag detected in the document head',
        'Configure CSP through server headers in production.'
      )
    );
  }

  const tokenInLocalStorage = (() => {
    try {
      return Object.keys(localStorage).some((key) => key.toLowerCase().includes('token'));
    } catch {
      return false;
    }
  })();

  if (tokenInLocalStorage) {
    issues.push(
      toIssue(
        'token-storage',
        'medium',
        'Potential token-like key found in localStorage',
        'Prefer sessionStorage or httpOnly cookies for auth tokens.'
      )
    );
  }

  const hiddenPasswordField = document.querySelector('input[type="password"]');
  if (hiddenPasswordField && hiddenPasswordField.getAttribute('autocomplete') === 'off') {
    issues.push(
      toIssue(
        'autocomplete',
        'low',
        'Password field has autocomplete="off"',
        'Using modern autocomplete values can improve security UX.'
      )
    );
  }

  return issues;
};

export default {
  runFrontendVulnerabilityChecks,
};
